<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Weather</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/stylesheet.css' %}"/>
    {% load static %}
    <link rel="icon" type="image/png" href="{% static 'img/favicon.png' %}"/>

    <style>
        #weather {
            position:relative;
            display: flex;
            align-items: center;
        }
        #icon {
            max-width: 50px;
            max-height: 50px;
            display:inline;
        }
        #temp {
            display:inline;
            font-size:2em;
            vertical-align:middle;
            margin:0px;
            padding:0px;
        }
        #json {
            font-family:monospace;
            white-space:pre;
        }
    </style>
</head>

<body>
    <div><b><a href="..">Home</a></b> &gt; <b>weather</b></div>
    <h1>Weather</h1>

<button onclick="getCurrentLocation(event)">Get Weather for Current Location</button>
<button onclick="getCherryHill(event)">Get Weather for Cherry Hill</button>

    <div id="weather">
        <img id="icon"/>
        <p id="temp"></p>
    </div>

<p id="json"></p>

<form class="logout" action="/accounts/logout/?next=/" method="post">
    {% csrf_token %}
    <button type="submit">Log out</button>
</form>

<script>
let json = document.getElementById("json");
function getCurrentLocation() {
  if (navigator.geolocation) {
    json.innerHTML = "Retrieving current location from device...";
    navigator.geolocation.getCurrentPosition(showPosition);
  } else {
    json.innerHTML = "Geolocation is not supported by this browser.";
  }
}

function getCherryHill() {
    let lat = '39.8688';
    let long = '-75.006';
    let url = '/weather/get_weather?lat=' + encodeURIComponent(lat) + '&lon=' + encodeURIComponent(long);
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", url, true); // false for synchronous request
    xmlHttp.onload = writeResult;
    json.innerHTML = "Retrieving weather for latitude " + lat + " / longitude " + long + " ...";
    xmlHttp.send(null);
}

function showPosition(position) {
    let lat = position.coords.latitude;
    let long = position.coords.longitude;
    let url = '/weather/get_weather?lat=' + encodeURIComponent(lat) + '&lon=' + encodeURIComponent(long);
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", url, true); // false for synchronous request
    xmlHttp.onload = writeResult;
    json.innerHTML = "Retrieving weather for latitude " + lat + " / longitude " + long + " ...";
    xmlHttp.send(null);
}

let temp = document.getElementById('temp');
let icon = document.getElementById('icon');
function writeResult(event) {
    let xmlHttp = event.target;
    let result = JSON.parse(xmlHttp.responseText);
    json.innerText = JSON.stringify(result, null, 2);
    let fahrenheit = ((9.0*(result.main.temp-273.15))/5)+32;
    temp.innerHTML = Math.round(fahrenheit * 10) / 10 + '&#8457;';
    icon.src = '/static/img/' + result.weather[0].icon + '.png';
}
</script>
</body>

</html>