<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timestamp Logger</title>
    <link rel="stylesheet" href="../css/stylesheet.css?v=01817" />
    <link rel="stylesheet" href="../css/loader.css?v=01817" />
    <link rel="icon" type="image/png" href="../img/alarm.favicon.png?v=01817" />
    <style>
.timeline {
  width: 100%;
  height: 10px;
  background-color: #eee;
  border: 1px solid black;
  position: relative;
  display: block;
  border-radius: 5px;
}
.timestamp {
    width: 10px;
    height: 100%;
    position: absolute;
    top: 0px;
    border: 1px black solid;
    box-sizing: border-box;
    border-radius: 50%;
    background-color: white;
}
    </style>
  </head>

  <body>
    <div>
      <b><a href="../index.html">Home</a></b> &gt; <b>timestamp-logger</b>
    </div>

    <div class="panel" id="Main">
      <div class="controls">
        <button onclick="openReport(event)">Report</button>
        <button onclick="showPanel('Edit')">Edit</button>
        <button onclick="logOut(event)">Log out</button>
      </div>

      <div style="display: inline">
        <input onchange="getTimestampValues(event)" id="date-picker" type="date" />
      </div>

      <div id="content">
        <div class="rounded-block">
          <div class="rounded-title">How it works</div>
          <ol style="margin-bottom:0px;">
            <li>Create timestamps by pressing the "Edit" button</li>
            <li>Press the "Log" button to set a value for a timestmp</li>
          </ol>
        </div>
      </div>
    </div>

    <div class="panel" id="Edit" style="display:none;">
      <div class="controls">
        <button onclick="showPanel('Main')">Back</button>
      </div>
      <div id="edit-content">
      </div>
      <button onclick="console.log('Not implemented')">+ Add New</button>
      <button onclick="console.log('Not implemented')">Save</button>
    </div>

    <script src="../js/utils.js?v=01817"></script>
    <script src="../js/env.js"></script>
    <script>
function getTimestamps(event) {
  let xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", API_DOMAIN + "/timestamps/get-timestamps", true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetTimestamps;
  xmlHttp.send(
    JSON.stringify({
      csrf: csrfToken
    })
  );
}

function handleGetTimestamps(event) {
  let result = defaultHandler(event);

  if(!result.responseJson || !result.responseJson.events || result.responseJson.events.length == 0) {
    return;
  }

  displayTimestamps(result.responseJson.events);
  getTimestampValues(event);
}

const content = document.getElementById('content');
const editDiv = document.getElementById('edit-content');

function displayTimestamps(timestampEvents) {
  while (content.firstElementChild) {
    content.firstElementChild.remove();
  }
  for (let timestampEvent of timestampEvents) {
    // The actual timestamp displays
    let outerDiv = document.createElement('div');
    outerDiv.classList.add('rounded-block');
    outerDiv.setAttribute('hash', timestampEvent.hash);

    let titleDiv = document.createElement('div');
    titleDiv.classList.add('rounded-title');
    titleDiv.innerText = timestampEvent.title;
    outerDiv.appendChild(titleDiv);

    let button = document.createElement('button');
    button.innerText = "Log timestamp";
    button.addEventListener('click', addTimestampCallback)
    outerDiv.appendChild(button);

    let hr = document.createElement('hr');
    hr.style.display = 'block';
    outerDiv.appendChild(hr);

    let timelineDiv = document.createElement('div');
    timelineDiv.classList.add('timeline')
    timelineDiv.setAttribute('hash', timestampEvent.hash);
    outerDiv.appendChild(timelineDiv);

    content.appendChild(outerDiv);

    // The timestamp edit window
    let questionDiv = document.createElement('div');
    questionDiv.classList.add('question-edit');
    questionDiv.classList.add('rounded-block-without-title');
    {
      let div = document.createElement('div');
      div.classList.add('question-controls');
      {
        let button = document.createElement('button');
        button.innerHTML = '&#8743;';
        // button.onclick = moveQuestionUp;
        div.appendChild(button);
      }
      {
        let button = document.createElement('button');
        button.innerHTML = '&#8744;';
        // button.onclick = moveQuestionDown;
        div.appendChild(button);
      }
      {
        let button = document.createElement('button');
        button.innerHTML = '&times;';
        // button.onclick = deleteQuestion;
        div.appendChild(button);
      }
      questionDiv.appendChild(div);
    }
    {
      let label = document.createElement('label');
      label.innerText = 'Question: ';
      let input = document.createElement('input');
      input.type = 'text';
      input.classList.add('question-text');
      input.defaultValue = timestampEvent.title;
      label.appendChild(input);
      questionDiv.appendChild(label);
    }

    editDiv.appendChild(questionDiv);
  }
}

function addTimestampCallback(event) {
  let outerDiv = findParentWithClass(event.target, 'rounded-block');
  let timestampHash = outerDiv.getAttribute('hash');
  let date = datePicker.value;
  let currentTime = Date.now();

  let xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", API_DOMAIN + "/timestamps/add-value", true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleAddTimestamp;
  xmlHttp.send(
    JSON.stringify({
      csrf: csrfToken,
      timestamp: currentTime,
      hash: timestampHash,
      date: date
    })
  );
}

function handleAddTimestamp(event) {
  let result = defaultHandler(event);

  getTimestampValues(event);
}

function getTimestampValues(event) {
  let xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", API_DOMAIN + "/timestamps/get-values", true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetTimestampValues;
  xmlHttp.send(
    JSON.stringify({
      csrf: csrfToken,
      date: datePicker.value
    })
  );
}

function handleGetTimestampValues(event) {
  let result = defaultHandler(event);
  
  if (!result.responseJson || !result.responseJson.values || Object.keys(result.responseJson.values).length == 0) {
    return;
  }
  
  for (let valueDiv of document.querySelectorAll(`div.timestamp-values[hash]`)) {
    while (valueDiv.firstElementChild) {
      valueDiv.firstElementChild.remove();
    }
  }
  
  for (let value of result.responseJson.values) {
    let timeValue = parseInt(value.timestamp);

    let timelineDiv = document.querySelector(`div.timeline[hash="${value.hash}"]`);
    if (!timelineDiv) {
      continue;
    }

    let dayStart = Date.parse((new Date()).toLocaleDateString());
    let ratio = (timeValue - dayStart) / (86400 * 1000);
    let percent = ratio * 100;
    let offset = ratio * 10;

    let timestampDiv = document.createElement('div');
    timestampDiv.classList.add('timestamp');
    timelineDiv.appendChild(timestampDiv);
    timestampDiv.style.left = `calc(${percent}% - ${offset}px)`;
  }
}

function openReport(event) {
  window.location.assign("report.html");
}

const datePicker = document.getElementById("date-picker");
datePicker.value = getTodayOrUrlParam();

applyEmulators();

getTimestamps();
    </script>
  </body>
</html>
