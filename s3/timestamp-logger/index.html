<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timestamp Logger</title>
    <link rel="stylesheet" href="../css/stylesheet.css?v=01817" />
    <link rel="stylesheet" href="../css/loader.css?v=01817" />
    <link rel="icon" type="image/png" href="../img/alarm.favicon.png?v=01817" />
    <style>
    </style>
  </head>

  <body>
    <div>
      <b><a href="../index.html">Home</a></b> &gt; <b>timestamp-logger</b>
    </div>

    <div class="panel" id="Main">
      <div class="controls">
        <button onclick="openReport(event)">Report</button>
        <button onclick="showPanel('Edit')">Edit</button>
        <button onclick="logOut(event)">Log out</button>
      </div>

      <div style="display: inline">
        <input onchange="getTimestampValues(event)" id="date-picker" type="date" />
      </div>

      <div id="content">
        <div class="rounded-block">
          <div class="rounded-title">How it works</div>
          <ol style="margin-bottom:0px;">
            <li>Create timestamps by pressing the "Edit" button</li>
            <li>Press the "Log" button to set a value for a timestmp</li>
          </ol>
        </div>
      </div>
    </div>

    <div class="panel" id="Edit" style="display:none;">
      <div class="controls">
        <button onclick="showPanel('Main')">&times;</button>
      </div>
    </div>

    <script src="../js/utils.js?v=01817"></script>
    <script src="../js/env.js"></script>
    <script>
function getTimestamps(event) {
  let xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", API_DOMAIN + "/timestamps/get-timestamps", true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetTimestamps;
  xmlHttp.send(
    JSON.stringify({
      csrf: csrfToken
    })
  );
}

function handleGetTimestamps(event) {
  let result = defaultHandler(event);
  console.log(result);

  if(result.responseJson.events) {
    displayTimestamps(result.responseJson.events);
    getTimestampValues(event);
  }
}

const content = document.getElementById('content');

function displayTimestamps(timestampEvents) {
  while (content.firstElementChild) {
    content.firstElementChild.remove();
  }
  for (let timestampEvent of timestampEvents) {
    let outerDiv = document.createElement('div');
    outerDiv.classList.add('rounded-block');
    outerDiv.setAttribute('hash', timestampEvent.hash);

    let titleDiv = document.createElement('div');
    titleDiv.classList.add('rounded-title');
    titleDiv.innerText = timestampEvent.title;
    outerDiv.appendChild(titleDiv);

    let button = document.createElement('button');
    button.innerText = "Log timestamp";
    button.addEventListener('click', addTimestampCallback)
    outerDiv.appendChild(button);

    let hr = document.createElement('hr');
    hr.style.display = 'block';
    outerDiv.appendChild(hr);

    let contentDiv = document.createElement('div');
    contentDiv.classList.add('timestamp-values')
    contentDiv.setAttribute('hash', timestampEvent.hash);
    outerDiv.appendChild(contentDiv);

    content.appendChild(outerDiv);
  }
}

function addTimestampCallback(event) {
  let outerDiv = findParentWithClass(event.target, 'rounded-block');
  let timestampHash = outerDiv.getAttribute('hash');
  let date = datePicker.value;
  let currentTime = Date.now();

  let xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", API_DOMAIN + "/timestamps/add-value", true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleAddTimestamp;
  xmlHttp.send(
    JSON.stringify({
      csrf: csrfToken,
      timestamp: currentTime,
      hash: timestampHash,
      date: date
    })
  );
}

function handleAddTimestamp(event) {
  let result = defaultHandler(event);

  getTimestampValues(event);
}

function getTimestampValues(event) {
  let xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", API_DOMAIN + "/timestamps/get-values", true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetTimestampValues;
  xmlHttp.send(
    JSON.stringify({
      csrf: csrfToken,
      date: datePicker.value
    })
  );
}

function handleGetTimestampValues(event) {
  let result = defaultHandler(event);
  
  if (!result.responseJson || !result.responseJson.values) {
    return;
  }
  
  for (let valueDiv of document.querySelectorAll(`div.timestamp-values[hash]`)) {
    while (valueDiv.firstElementChild) {
      valueDiv.firstElementChild.remove();
    }
  }
  
  for (let value of result.responseJson.values) {
    let valueDiv = document.querySelector(`div.timestamp-values[hash="${value.hash}"]`);
    if (!valueDiv) {
      continue;
    }
    let item = document.createElement('div');
    item.innerText = `${new Date(parseInt(value.timestamp))}`;
    valueDiv.appendChild(item);
  }
}

const datePicker = document.getElementById("date-picker");
datePicker.value = getTodayOrUrlParam();

applyEmulators();

getTimestamps();
    </script>
  </body>
</html>
