<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Dumbphone Apps</title>
    <link rel="stylesheet" href="css/stylesheet.css?v=8"/>
    <link rel="icon" type="image/png" href="img/favicon.png?v=3"/>
</head>

<body>

<h2>Log In</h2>
<form method="post" onsubmit="sendOtp(event)">
    <p>
        <label for="phone">Telephone Number:</label>
        <input class="big" type="tel" id="phone" name="phone">
    </p>
    <p>
        <label for="otp">OTP:</label>
        <input class="big" type="number" id="otp" name="otp">
    </p>
    <button type="submit">Log In</button>
</form>
<div style="display:none" id="message" class="error">
</div>
<script src="js/utils.js?v=3"></script>
<script>
    const messageDiv = document.getElementById('message');
    let xmlHttp = undefined;
    function sendOtp(event) {
        event.preventDefault();
        const phone = document.getElementById('phone').value;
        const otp = document.getElementById('otp').value;
        
        let url = API_DOMAIN + '/login';
        xmlHttp = new XMLHttpRequest();
        xmlHttp.open("POST", url, true); // false for synchronous request
        xmlHttp.withCredentials = true;
        xmlHttp.onload = handle;
        xmlHttp.send(JSON.stringify({'phone': phone, 'otp': otp}));
    }
    function handle(event) {
        let xmlHttp = event.target;
        if (xmlHttp.status == 200) {
            const csrfToken = xmlHttp.getResponseHeader('x-csrf-token');
            localStorage.setItem('dumbphoneapps-csrf-token', csrfToken);
            window.location.replace("index.html");
        } else {
            let result = JSON.parse(xmlHttp.responseText);
            if (result.hasOwnProperty('message')) {
                messageDiv.style.display = 'block';
                messageDiv.textContent = result.message;
                if (result.message.includes('expired')) {
                    setTimeout(function () {
                        window.location.replace("/signup.html");
                    }, 2000);
                }
            }
        }
    }
    function fillOutPhoneNumberBoxWithSearchParam() {
        const urlParams = new URLSearchParams(window.location.search);
        const username = urlParams.get('username')
        if(!!username) {
            document.getElementById('phone').value = username;
        }
    }
    fillOutPhoneNumberBoxWithSearchParam()
</script>
</body>

</html>