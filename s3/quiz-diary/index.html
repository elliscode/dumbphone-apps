<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Location Viewer</title>
    <link rel="stylesheet" href="../css/stylesheet.css?v=001" />
    <link rel="stylesheet" href="../css/loader.css?v=001" />
    <link rel="icon" type="image/png" href="../img/favicon.png?v=001" />
    <style>
.controls {
  position: absolute;
  top: 8px;
  right: 8px;
}
.modal {
  background-color:rgb(255, 255, 255);
  border-color:rgb(53, 53, 53);
}
.modal-bg {
  background-color:rgba(0, 0, 0, 0.1);
}
.question-edit {
  margin: 10px 0px;
}
.question-edit label {
  display:block;
}
#question-container {
  max-height:300px;
  height:calc(100vh - 80px);
  max-width:100vw;
  overflow-y: scroll;
}
.question-controls {
  display: flex;
  justify-content: flex-end;
}
    </style>
  </head>

  <body>
    <div>
      <b><a href="../index.html">Home</a></b> &gt; <b>quiz-diary</b>
    </div>

    <div id="loading">
      <div class="lds-spinner">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <div class="controls">
      <button onclick="openSettings(event)">Edit</button>
    </div>

    <div style="display: inline">
      <input onchange="getAnswers(event)" id="date-picker" type="date" />
    </div>

    <div id="explanation" style="display:none;">
      <h3>How does it work?</h3>
      <ol>
        <li>Come up with a list of daily questions</li>
        <li>Build them in the app and save</li>
        <li>Answer them every day to stay on track</li>
      </ol>
      <p>Examples:</p>
      <blockquote>Did you take your medicine today? <button>Yes</button> / <button>No</button></blockquote>
      <blockquote>How long did you exercise today? <input type="tel" /> min</blockquote>
      <p>Press the "Edit" button at the top-right to begin.</p>
    </div>

    <div style="display: none" id="edit-div" class="modal-bg">
      <div class="modal">
        <div id="question-container">
        </div>
        <button onclick="addQuestionToEdit(event)">+ Add new question</button>
        <hr />
        <button onclick="saveQuestions(event)" id="save-settings">Save</button>
        <button onclick="closeModals(event)" id="cancel-settings">Cancel</button>
      </div>
    </div>

    <div style="display: none" class="logout">
      <button onclick="logOut(event)">Log out</button>
    </div>
    <script src="../js/utils.js?v=001"></script>
    <script>
const RESPONSE_LIST_QUESTIONS = ['radio','check'];
let questions = undefined;

function getQuizDiary() {
  let url = API_DOMAIN + "/quiz-diary/get-questions";
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", url, true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleQuizDiary;
  xmlHttp.onerror = handleQuizDiary;
  xmlHttp.send(JSON.stringify({csrf: csrfToken}));
}

function handleQuizDiary(event) {
  let xmlHttp = event.target;
  let result = defaultHandler(event);
  let responseJson = result.responseJson;
  questions = responseJson.questions;
  if (questions && Array.isArray(questions) && questions.length > 0) {
    getAnswers(event);
  } else {
    const explanation = document.getElementById("explanation");
    explanation.style.display = "block";
  }
  const loader = document.getElementById("loading");
  loader.style.display = "none";
}

function getAnswers(event) {
  let url = API_DOMAIN + "/quiz-diary/get-answers";
  payload = {csrf: csrfToken, questions: questions};
  if (event && event.target && event.target.value && /^\d{4}-\d{2}-\d{2}$/.exec(event.target.value)) {
    payload['date'] = event.target.value;
  } else {
    payload['date'] = getToday();
  }
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", url, true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetAnswers;
  xmlHttp.onerror = handleGetAnswers;
  xmlHttp.send(JSON.stringify(payload));
}

function getToday() {
  let d = new Date();
  let year = (d.getFullYear()).toString();
  let month = (d.getMonth() + 1).toString();
  let day = (d.getDate()).toString();
  
  if (month.length < 2) {
    month = '0' + month;
  }
  if (day.length < 2) {
    day = '0' + day;
  }

  return `${year}-${month}-${day}`;
}

function handleGetAnswers(event) {
  
}

function closeModals(event) {
  let items = Array.from(document.getElementsByClassName('modal-bg'));
  for (let item of items) {
    item.style.display = 'none';
  }
}

function openSettings(event) {
  closeModals();
  let modalToShow = document.getElementById('edit-div');
  modalToShow.style.display = "flex";
}

function showResponseList(event) {
  let questionBlock = findParentWithClass(event.target, 'question-edit');
  let responseList = questionBlock.getElementsByClassName('response-list')[0];
  let responseListTextBox = questionBlock.getElementsByClassName('response-list-textbox')[0];
  let selectedValue = Array.from(event.target.selectedOptions)[0].value;
  let newDisplayValue = 'none';
  if (RESPONSE_LIST_QUESTIONS.includes(selectedValue)) {
    newDisplayValue = 'block';
  }
  if (responseList.style.display != newDisplayValue) {
    responseListTextBox.value = '';
    responseList.style.display = newDisplayValue;
  }
}

function addQuestionToEdit(event) {
  let questionContainer = document.getElementById('question-container');
  let questionDiv = document.createElement('div');
  questionDiv.classList.add('question-edit');
  {
    let div = document.createElement('div');
    div.classList.add('question-controls');
    {
      let button = document.createElement('button');
      button.innerHTML = '&#8743;';
      button.onclick = moveQuestionUp;
      div.appendChild(button);
    }
    {
      let button = document.createElement('button');
      button.innerHTML = '&#8744;';
      button.onclick = moveQuestionDown;
      div.appendChild(button);
    }
    {
      let button = document.createElement('button');
      button.innerHTML = '&times;';
      button.onclick = deleteQuestion;
      div.appendChild(button);
    }
    questionDiv.appendChild(div);
  }
  {
    let label = document.createElement('label');
    label.innerText = 'Question: ';
    let input = document.createElement('input');
    input.type = 'text';
    input.classList.add('question-text');
    label.appendChild(input);
    questionDiv.appendChild(label);
  }
  {
    let label = document.createElement('label');
    label.innerText = 'Response type: ';
    let input = document.createElement('select');
    input.onchange = showResponseList;
    {
      let option = document.createElement('option');
      option.value = 'yn';
      option.innerText = 'Yes / No';
      input.appendChild(option);
    }
    {
      let option = document.createElement('option');
      option.value = 'radio';
      option.innerText = 'Radio buttons';
      input.appendChild(option);
    }
    {
      let option = document.createElement('option');
      option.value = 'check';
      option.innerText = 'Checkboxes';
      input.appendChild(option);
    }
    {
      let option = document.createElement('option');
      option.value = 'quantity';
      option.innerText = 'Numerical quantity';
      input.appendChild(option);
    }
    {
      let option = document.createElement('option');
      option.value = 'text';
      option.innerText = 'Text';
      input.appendChild(option);
    }
    {
      let option = document.createElement('option');
      option.value = 'list';
      option.innerText = 'List of text';
      input.appendChild(option);
    }
    label.appendChild(input);
    questionDiv.appendChild(label);
  }
  {
    let label = document.createElement('label');
    label.innerText = 'Response list: ';
    label.classList.add('response-list');
    let input = document.createElement('input');
    input.type = 'text';
    input.classList.add('response-list-textbox');
    label.appendChild(input);
    label.style.display = 'none';
    questionDiv.appendChild(label);
  }
  questionContainer.appendChild(questionDiv);
}

function moveQuestionUp(event) {
  let questionBlock = findParentWithClass(event.target, 'question-edit');
  let prev = questionBlock.previousElementSibling;
  if (prev) {
    questionBlock.parentElement.insertBefore(questionBlock, prev);
  }
}

function moveQuestionDown(event) {
  let questionBlock = findParentWithClass(event.target, 'question-edit');
  let next = questionBlock.nextElementSibling;
  if (next) {
    questionBlock.parentElement.insertBefore(next, questionBlock);
  }
}

function deleteQuestion(event) {
  let questionBlock = findParentWithClass(event.target, 'question-edit');
  questionBlock.remove();
}

function generateJsonFromEditWindow(event) {
  let questionContainer = document.getElementById('question-container');
  let questions = Array.from(questionContainer.getElementsByClassName('question-edit'));
  let output = [];
  for (let question of questions) {
    let questionType = question.getElementsByTagName('select')[0].selectedOptions[0].value;
    let questionText = question.getElementsByClassName('question-text')[0].value;
    let jsonQuestion = {
      'question': questionText,
      'type': questionType
    }
    if (RESPONSE_LIST_QUESTIONS.includes(questionType)) {
      let responseList = question.getElementsByClassName('response-list-textbox')[0].value;
      let responses = responseList.split(/\s*,\s*/g);
      jsonQuestion['responses'] = responses;
    }
    if (!jsonQuestion.question) {
      continue;
    }
    output.push(jsonQuestion);
  }
  return output;
}

function saveQuestions(event) {
  questions = generateJsonFromEditWindow();
  
  let url = API_DOMAIN + "/quiz-diary/set-questions";
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", url, true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleSaveQuestions;
  xmlHttp.onerror = handleSaveQuestions;
  xmlHttp.send(JSON.stringify({csrf: csrfToken, questions: questions}));
}

function handleSaveQuestions(event) {
  let result = defaultHandler(event);
  let responseJson = result.responseJson;
  renderQuestions();
}

function renderQuestions(event) {
  // todo
}

// if (!csrfToken) {
//   window.location.replace("../signup.html");
// }
// if (
//   !navigator.userAgent.includes("Chrome") &&
//   navigator.userAgent.includes("Safari")
// ) {
//   iosCookieRefresh();
// }

getQuizDiary();
    </script>
  </body>
</html>
