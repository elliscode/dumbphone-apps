<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Diary Weekly Report</title>
    <link rel="stylesheet" href="../css/stylesheet.css?v=001" />
    <link rel="stylesheet" href="../css/loader.css?v=001" />
    <link rel="icon" type="image/png" href="../img/favicon.png?v=001" />
    <style>
.rotated td span {
  -ms-writing-mode: tb-rl;
  -webkit-writing-mode: vertical-rl;
  writing-mode: vertical-rl;
  transform: rotate(0deg);
  white-space: nowrap;
}
    </style>
  </head>

  <body>
    <div>
      <b><a href="../index.html">Home</a></b> &gt; <b><a href="index.html">quiz-diary</a></b> &gt; <b>quiz-diary-report</b>
    </div>

    <div id="loading">
      <div class="lds-spinner">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <div style="display: inline">
      <input onchange="getReportData(event)" id="date-picker" type="date" />
    </div>

    <pre id="json-pre"></pre>

    <div style="display: none" class="logout">
      <button onclick="logOut(event)">Log out</button>
    </div>
    <script src="../js/utils.js?v=001"></script>
    <script>
const datePicker = document.getElementById('date-picker');
const loader = document.getElementById("loading");
const pre = document.getElementById("json-pre");
let questions = undefined;
let reportData = undefined;

function getToday() {
  let d = new Date();
  let year = (d.getFullYear()).toString();
  let month = (d.getMonth() + 1).toString();
  let day = (d.getDate()).toString();
  
  if (month.length < 2) {
    month = '0' + month;
  }
  if (day.length < 2) {
    day = '0' + day;
  }

  return `${year}-${month}-${day}`;
}

function getQuestions() {
  let url = API_DOMAIN + "/quiz-diary/get-questions";
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", url, true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetQuestions;
  xmlHttp.onerror = handleGetQuestions;
  xmlHttp.send(JSON.stringify({csrf: csrfToken}));
}

function handleGetQuestions(event) {
  let xmlHttp = event.target;
  let result = defaultHandler(event);
  let responseJson = result.responseJson;
  questions = responseJson.questions;
  if (questions && Array.isArray(questions) && questions.length > 0) {
    getReportData(event);
  } else {
    pre.innerText = 'No data';
    loader.style.display = "none";
  }
}

function getReportData(event) {
  loader.style.display = "block";
  let url = API_DOMAIN + "/quiz-diary/get-report-data";
  payload = {csrf: csrfToken, date: datePicker.value};
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open("POST", url, true);
  xmlHttp.withCredentials = true;
  xmlHttp.onload = handleGetReportData;
  xmlHttp.onerror = handleGetReportData;
  xmlHttp.send(JSON.stringify(payload));
}

function handleGetReportData(event) {
  let result = defaultHandler(event);
  reportData = result.responseJson.sort((r1,r2)=>r1.date.localeCompare(r2.date));
  // pre.innerText = JSON.stringify(reportData, undefined, 2);
  drawTrueOrFalseTable();
}

document.addEventListener("keydown", function(e) {
  if (e.key === 's' && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
    e.preventDefault();
    save();
  }
}, false);

datePicker.value = getToday();
// reportData = reportData.sort((r1,r2)=>r1.date.localeCompare(r2.date))
getQuestions();

function drawTrueOrFalseTable() {
  let ynQuestions = questions.filter(q=>q.type==="yn");
  let table = document.createElement('table');
  {
    let row = document.createElement('tr');
    row.classList.add('rotated');
    {
      let td = document.createElement('td');
      row.appendChild(td);
    }
    for (let item of reportData) {
      let td = document.createElement('td');
      let span = document.createElement('span');
      span.innerText = item.date;
      td.appendChild(span);
      row.appendChild(td);
    }
    table.appendChild(row);
  }
  for (let question of ynQuestions) {
    let row = document.createElement('tr');
    {
      let td = document.createElement('td');
      td.innerText = question.question;
      row.appendChild(td);
    }
    for (let item of reportData) {
      let td = document.createElement('td');
      if (item.answers.hasOwnProperty(question.hash) && item.answers[question.hash].value) {
        td.innerHTML = '&#9989;';
      } else {
        td.innerHTML = '&#9940;';
      }
      row.appendChild(td);
    }
    table.append(row);
  }
  document.body.appendChild(table);
  loader.style.display = "none";
}
    </script>
  </body>
</html>
