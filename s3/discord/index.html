<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Discord Client</title>
    <link rel="stylesheet" href="../css/stylesheet.css?v=5"/>
    <link rel="stylesheet" href="../css/loader.css?v=3"/>
    <link rel="icon" type="image/png" href="../img/favicon.png?v=3"/>
    <style>
        body {
            padding-bottom: 30px;
        }
        .add-to-group button {
            height:20px;
        }
        .settings {
            position:fixed;
            bottom:0px;
            right:0px;
        }
        img {
            max-width:700px;
        }
        .delete-button {
            margin-left: 5px;
        }
    </style>
</head>

<body>
<div><b><a href="../index.html">Home</a></b> &gt; <b>discord</b></div>

<button class="settings" for="settings-div" onclick="openSettings(event)">Settings</button>

<div style="display:none;" id="settings-div" class="modal-bg">
    <div class="modal">
        <label>Discord Token:</label>
        <input id="token" type="text"></input>
        <hr />
        <button id="save-settings" onclick="setToken(event)">Save</button>
        <button id="cancel-settings" onclick="hideAllModals(event)">Cancel</button>
    </div>
</div>

<hr />

<div id="loading">
    <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
</div>

<div class="logout">
    <button onclick="logOut(event)">Log out</button>
</div>
<script src="../js/utils.js?v=3"></script>
<script>
const messageTypes = ['DEFAULT', 'RECIPIENT_ADD', 'RECIPIENT_REMOVE', 'CALL', 'CHANNEL_NAME_CHANGE', 'CHANNEL_ICON_CHANGE', 'CHANNEL_PINNED_MESSAGE', 'USER_JOIN', 'GUILD_BOOST', 'GUILD_BOOST_TIER_1', 'GUILD_BOOST_TIER_2', 'GUILD_BOOST_TIER_3', 'CHANNEL_FOLLOW_ADD', 'GUILD_DISCOVERY_DISQUALIFIED', 'GUILD_DISCOVERY_REQUALIFIED', 'GUILD_DISCOVERY_GRACE_PERIOD_INITIAL_WARNING', 'GUILD_DISCOVERY_GRACE_PERIOD_FINAL_WARNING', 'THREAD_CREATED', 'REPLY', 'CHAT_INPUT_COMMAND', 'THREAD_STARTER_MESSAGE', 'GUILD_INVITE_REMINDER', 'CONTEXT_MENU_COMMAND', 'AUTO_MODERATION_ACTION', 'ROLE_SUBSCRIPTION_PURCHASE', 'INTERACTION_PREMIUM_UPSELL', 'STAGE_START', 'STAGE_END', 'STAGE_SPEAKER', 'STAGE_TOPIC', 'GUILD_APPLICATION_PREMIUM_SUBSCRIPTION'];
const loader = document.getElementById('loading');
const tokenBox = document.getElementById('token');
// check if you had a token saved
function setToken() {
    let url = API_DOMAIN + '/set-discord-token';
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleSetToken;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
    }
    xmlHttp.send(JSON.stringify(payload));
}
function handleSetToken(event) {
    hideAllModals();
}
function getToken() {
    let url = API_DOMAIN + '/get-discord-token';
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleGetToken;
    let payload = {
        'csrf': csrfToken,
    }
    xmlHttp.send(JSON.stringify(payload));
}
function handleGetToken(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)
    if (responseJson.discordToken) {
        tokenBox.value = responseJson.discordToken;
    }
    const loadGuildsButton = document.createElement('button');
    loadGuildsButton.classList.add('discord');
    loadGuildsButton.onclick=getUser;
    loadGuildsButton.innerText = "Load Guilds";
    document.body.appendChild(loadGuildsButton);
    loader.style.display = 'none';
}

function clearDiscordButtons() {
    let discordButtons = Array.from(document.getElementsByClassName('discord'));
    for (let i = discordButtons.length - 1; i >= 0; i--) {
        let discordButton = discordButtons[i];
        discordButton.remove();
    }
}

function getUser() {
    loader.style.display = 'block';
    clearDiscordButtons();
    let url = API_DOMAIN + '/discord/api/v10/users/@me';
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleUser;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'GET',
    }
    xmlHttp.send(JSON.stringify(payload));
}

let userId = undefined;
function handleUser(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)

    userId = responseJson.id;

    getGuilds();
}

function getGuilds() {
    let url = API_DOMAIN + '/discord/api/v10/users/@me/guilds';
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handeGuilds;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'GET',
    }
    xmlHttp.send(JSON.stringify(payload));
}

function handeGuilds(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)

    for (let i = 0; i < responseJson.length; i++) {
        let guild = responseJson[i];
        let guildButton = document.createElement('button');
        guildButton.classList.add('discord');
        guildButton.textContent = guild.name;
        guildButton.setAttribute('discord-id', guild.id);
        guildButton.onclick=getChannels;
        document.body.appendChild(guildButton);
    }
    loader.style.display = 'none';
}

function getChannels(event) {
    loader.style.display = 'block';
    clearDiscordButtons();
    let url = `${API_DOMAIN}/discord/api/v10/guilds/${event.target.getAttribute('discord-id')}/channels`;
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleChannels;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'GET',
    }
    xmlHttp.send(JSON.stringify(payload));
}

function handleChannels(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)

    for (let i = 0; i < responseJson.length; i++) {
        let channel = responseJson[i];
        if (channel.type != 0) {
            continue;
        }
        let channelButton = document.createElement('button');
        channelButton.classList.add('discord');
        channelButton.textContent = channel.name;
        channelButton.setAttribute('discord-id', channel.id);
        channelButton.onclick=getMessages;
        document.body.appendChild(channelButton);
    }
    loader.style.display = 'none';
}

let channelId = undefined;
function getMessages(event) {
    loader.style.display = 'block';
    clearDiscordButtons();
    channelId = event.target.getAttribute('discord-id');
    let url = `${API_DOMAIN}/discord/api/v10/channels/${channelId}/messages`;
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleMessages;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'GET',
    }
    xmlHttp.send(JSON.stringify(payload));
}

function handleMessages(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)

    const refreshButton = document.createElement('button');
    refreshButton.innerText = 'Refresh';
    refreshButton.classList.add('discord');
    refreshButton.style.display = 'block';
    refreshButton.setAttribute('discord-id', channelId);
    refreshButton.onclick=getMessages;
    document.body.appendChild(refreshButton);

    const textBox = document.createElement('textarea');
    textBox.classList.add('discord');
    textBox.style.display = 'block';
    textBox.id='message-box';
    textBox.onkeyup=enterKeyListener;
    document.body.appendChild(textBox);

    const submitButton = document.createElement('button');
    submitButton.classList.add('discord');
    submitButton.innerText = 'Send';
    submitButton.onclick=sendMessage;
    submitButton.setAttribute('discord-id', channelId);
    submitButton.id="submit";
    submitButton.style.display = 'block';
    document.body.appendChild(submitButton);

    for (let i = 0; i < responseJson.length; i++) {
        let message = responseJson[i];
        let p = document.createElement('p');
        buildMessage(p, message);
        document.body.appendChild(p);
    }
    loader.style.display = 'none';
}
function buildMessage(parentElement, message) {
    parentElement.setAttribute('discord-id', message.id);
    parentElement.classList.add('discord');
    if (message.hasOwnProperty('referenced_message')) {
        let blockQuote = document.createElement('blockquote');
        parentElement.appendChild(blockQuote);
        buildMessage(blockQuote, message.referenced_message);
    }
    {
        let span = document.createElement('a');
        if (message.author.global_name) {
            span.innerHTML = message.author.global_name;
        } else {
            span.innerText = message.author.username;
        }
        if (message.author.id != userId) {
            span.onclick=openDirectMessage;
            span.setAttribute('discord-id', message.author.id);
            span.style.cursor='pointer';
        }
        parentElement.appendChild(span);
    }
    {
        let span = document.createElement('span');
        span.innerHTML = ' &mdash; ';
        parentElement.appendChild(span);
    }
    if (!message.content && message.embeds.length == 0 && message.attachments.length == 0) {
        let span = document.createElement('span');
        span.innerText = messageTypes[message.type];
        parentElement.appendChild(span);
    }
    {
        let span = document.createElement('span');
        span.innerText = message.content;
        if (message.mentions) {
            for (let mention of message.mentions) {
                let mentionTag = `<@${mention.id}>`;
                let mentionTagHtml = `&lt;@${mention.id}&gt;`;
                if (!message.content.includes(mentionTag)) {
                    continue;
                }
                let a = document.createElement('a');
                if (mention.global_name) {
                    a.innerText = mention.global_name;
                } else {
                    a.innerText = mention.username;
                }
                if (mention.id != userId) {
                    a.onclick=openDirectMessage;
                    a.setAttribute('discord-id', mention.id);
                    a.style.cursor='pointer';
                }
                span.innerHTML = span.innerHTML.replace(mentionTagHtml, a.outerHTML);
            }
        }
        parentElement.appendChild(span);
    }
    if (message.reactions) {
        for (let reaction of message.reactions) {
            let topSub = document.createElement('sub');
            {
                let span = document.createElement('span');
                span.innerText = reaction.emoji.name;
                topSub.appendChild(span);
            }
            {
                let sub = document.createElement('sub');
                sub.innerText = reaction.count;
                topSub.appendChild(sub);
            }
            parentElement.appendChild(topSub);
        }
    }
    if (message.author.id == userId) {
        let deleteButton = document.createElement('button');
        deleteButton.innerHTML = '&times;';
        deleteButton.classList.add('delete-button');
        deleteButton.setAttribute('discord-id', message.id);
        deleteButton.onclick=deleteMessage;
        parentElement.appendChild(deleteButton);
    }
    if (message.embeds) {
        for (let embed of message.embeds) {
            if (embed.hasOwnProperty('description')) {
                let lineBreak = document.createElement('br');
                parentElement.appendChild(lineBreak);
                let embedDescription = document.createElement('span');
                embedDescription.textContent = embed.description;
                parentElement.appendChild(embedDescription);
            }
            if (embed.hasOwnProperty('url')) {
                let lineBreak = document.createElement('br');
                parentElement.appendChild(lineBreak);
                let embedLink = document.createElement('a');
                embedLink.href = embed.url;
                if (embed.title) {
                    embedLink.innerText = embed.title;
                } else {
                    embedLink.innerText = embed.url;
                }
                parentElement.appendChild(embedLink);
            }
            if (embed.hasOwnProperty('image')) {
                let lineBreak = document.createElement('br');
                parentElement.appendChild(lineBreak);
                let embedImg = document.createElement('img');
                embedImg.src = embed.image.url;
                parentElement.appendChild(embedImg);
            }
        }
    }
    if (message.attachments) {
        for (let attachment of message.attachments) {
            let lineBreak = document.createElement('br');
            parentElement.appendChild(lineBreak);
            let attachmentImg = document.createElement('img');
            attachmentImg.src = attachment.url;
            parentElement.appendChild(attachmentImg);
        }
    }
}
function openDirectMessage(event) {
    loader.style.display = 'block';
    clearDiscordButtons();
    let url = `${API_DOMAIN}/discord/api/v10/users/@me/channels`;
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleOpenDirectMessage;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'POST',
        'recipient_id': event.target.getAttribute('discord-id'),
    }
    xmlHttp.send(JSON.stringify(payload));
}
function handleOpenDirectMessage(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)
    channelId = responseJson.id;
    getMessages({'target': {'getAttribute': ()=>{return channelId}}});
}
function deleteMessage(event) {
    loader.style.display = 'block';
    clearDiscordButtons();

    let url = API_DOMAIN + `/discord/api/v10/channels/${channelId}/messages/${event.target.getAttribute('discord-id')}`;
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleDeleteMessage;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'DELETE',
    }
    xmlHttp.send(JSON.stringify(payload));
}

function handleDeleteMessage(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)
    getMessages({'target': {'getAttribute': ()=>{return channelId}}});
}

function sendMessage(event) {
    let messageBox = document.getElementById('message-box');
    let submitButton = document.getElementById('submit');
    const messageText = messageBox.value;

    loader.style.display = 'block';
    clearDiscordButtons();

    let url = `${API_DOMAIN}/discord/api/v10/channels/${event.target.getAttribute('discord-id')}/messages`;
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleSendMessage;
    let payload = {
        'csrf': csrfToken,
        'discordToken': tokenBox.value,
        'method': 'POST',
        'content': messageText,
    }
    xmlHttp.send(JSON.stringify(payload));
}

function handleSendMessage(event) {
    let xmlHttp = event.target;
    let responseJson = JSON.parse(xmlHttp.responseText)
    getMessages({'target': {'getAttribute': ()=>{return channelId}}});
}

function enterKeyListener(event) {
    event.preventDefault();
    if (event.keyCode === 13) {
        document.getElementById("submit").click();
    }
}

function hideAllModals() {
    let modalBgs = Array.from(document.getElementsByClassName('modal-bg'));
    for (let i = 0; i < modalBgs.length; i++) {
        modalBgs[i].style.display = 'none';
    }
}

function openSettings(event) {
    hideAllModals();
    let forId = event.target.getAttribute('for');
    let modalToShow = document.getElementById(forId);
    modalToShow.style.display = 'flex';
}

if (!csrfToken) {
    window.location.replace("../signup.html");
}
if (!navigator.userAgent.includes('Chrome') && navigator.userAgent.includes('Safari')) {
    iosCookieRefresh();
}
getToken();
</script>
</body>

</html>