<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Thermostat</title>
    <link rel="stylesheet" href="../css/stylesheet.css?v=013" />
    <link rel="stylesheet" href="../css/loader.css?v=013" />
    <link rel="icon" type="image/png" href="../img/favicon.png?v=013" />
    <style>
    </style>
  </head>

  <body>
    <div>
      <b><a href="../index.html">Home</a></b> &gt; <b>thermostat</b>
    </div>

    <a href="https://nestservices.google.com/partnerconnections/2d07542a-86b2-4edc-84e6-20004c25a42d/auth?redirect_uri=https://aws.dumbphoneapps.com/thermostat/index.html&access_type=offline&prompt=consent&client_id=483860665172-4h3cvjgenh1177s8hp1p7bjhl92dufg8.apps.googleusercontent.com&response_type=code&scope=https://www.googleapis.com/auth/sdm.service">
      Connect your Nest thermostat account
    </a>

    <div id="controls"></div>

    <div class="logout">
      <button onclick="logOut(event)">Log out</button>
    </div>
    <script src="../js/utils.js?v=013"></script>
    <script src="../js/env.js"></script>
    <script>
const controlsDiv = document.getElementById('controls');
const projectId = '2d07542a-86b2-4edc-84e6-20004c25a42d';
let authorizationCode = getParameterByName('code');
let bearerToken = undefined;
let deviceId = undefined;
let structureId = undefined;
let roomId = undefined;
// function getStructures() {
//   let url = `https://smartdevicemanagement.googleapis.com/v1/enterprises/${projectId}/structures`;
//   xmlHttp = new XMLHttpRequest();
//   xmlHttp.open("GET", url, true);
//   xmlHttp.setRequestHeader('authorization', `Bearer ${bearerToken}`);
//   xmlHttp.withCredentials = false;
//   xmlHttp.onload = handleStructures;
//   xmlHttp.send();
// }
// function handleStructures(event) {
//   while(controlsDiv.firstElementChild) {
//     controlsDiv.firstElementChild.remove();
//   }
//   let data = defaultHandler(event);
//   for (let structure of data.responseJson.structures) {
//     let button = document.createElement('button');
//     button.innerText = structure.traits['sdm.structures.traits.Info'].customName;
//     button.setAttribute('url', structure.name);
//     button.addEventListener('click', getRooms);
//     controlsDiv.appendChild(button);
//   }
// }
// function getRooms(event) {
//   const suffix = event.target.getAttribute('url');
//   let url = `https://smartdevicemanagement.googleapis.com/v1/${suffix}/rooms`;
//   xmlHttp = new XMLHttpRequest();
//   xmlHttp.open("GET", url, true);
//   xmlHttp.setRequestHeader('authorization', `Bearer ${bearerToken}`);
//   xmlHttp.withCredentials = false;
//   xmlHttp.onload = handleRooms;
//   xmlHttp.send();
// }
// function handleRooms(event) {
//   while(controlsDiv.firstElementChild) {
//     controlsDiv.firstElementChild.remove();
//   }
//   let data = defaultHandler(event);
//   for (let room of data.responseJson.rooms) {
//     let button = document.createElement('button');
//     button.innerText = room.traits['sdm.structures.traits.RoomInfo'].customName;
//     button.setAttribute('url', room.name);
//     button.addEventListener('click', getDevices);
//     controlsDiv.appendChild(button);
//   }
// }
function getDevices() {
  let url = `https://smartdevicemanagement.googleapis.com/v1/enterprises/${projectId}/devices`;
  xmlHttp = new XMLHttpRequest();
  xmlHttp.open("GET", url, true);
  xmlHttp.setRequestHeader('authorization', `Bearer ${bearerToken}`);
  xmlHttp.withCredentials = false;
  xmlHttp.onload = handleDevices;
  xmlHttp.send();
}
function handleDevices(event) {
  while(controlsDiv.firstElementChild) {
    controlsDiv.firstElementChild.remove();
  }
  let data = defaultHandler(event);
  for (let device of data.responseJson.devices) {
    let pre = document.createElement('pre');
    pre.innerText = JSON.stringify(device.traits, undefined, 2);
    controlsDiv.appendChild(pre);
  }
}
function checkIfYouHaveAuthCode(event) {
  // if you have a code in your URI, then send it and get a token
  if (authorizationCode) {
    let url = API_DOMAIN + "/thermostat/get-token-from-code";
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleGetTokenFromCode;
    xmlHttp.send(JSON.stringify({ csrf: csrfToken, code: authorizationCode }));
  } else { // if you don't have a code in your URI, check for a refresh token
    let url = API_DOMAIN + "/thermostat/get-token-from-existing-refresh-token";
    let xmlHttp = new XMLHttpRequest();
    xmlHttp.open("POST", url, true);
    xmlHttp.withCredentials = true;
    xmlHttp.onload = handleGetTokenFromExistingRefreshToken;
    xmlHttp.send(JSON.stringify({ csrf: csrfToken }));
  }
}

function handleGetTokenFromCode(event) {
  let result = defaultHandler(event, false);
  if (result.statusCode == 200) {
    bearerToken = result.responseJson.access_token;
    getDevices();
  }
}

function handleGetTokenFromExistingRefreshToken(event) {
  let result = defaultHandler(event, false);
  if (result.statusCode == 200) {
    bearerToken = result.responseJson.access_token;
    getDevices();
  }
}


checkIfYouHaveAuthCode(event);
    </script>
  </body>
</html>
