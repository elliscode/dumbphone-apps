<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Dumbphone Apps</title>
    <link rel="stylesheet" href="css/stylesheet.css?v=3"/>
    <link rel="icon" type="image/png" href="img/favicon.png?v=3"/>
</head>

<body>

<h2>Log In</h2>
<form method="post" onsubmit="sendOtp(event)">
    <p>
        <label for="phone">Telephone Number:</label>
        <input class="big" type="tel" id="phone" name="phone">
    </p>
    <button type="submit">Log In</button>
</form>
<div style="display:none" id="message" class="error">
</div>
<script src="js/utils.js?v=3"></script>
<script>
    const messageDiv = document.getElementById('message');
    function sendOtp(event) {
        event.preventDefault();
        const phone = document.getElementById('phone').value;
        
        let url = API_DOMAIN + '/otp';
        let xmlHttp = new XMLHttpRequest();
        xmlHttp.open("POST", url, true); // false for synchronous request
        xmlHttp.withCredentials = true;
        xmlHttp.onload = handle;
        xmlHttp.onerror = handleError;
        xmlHttp.send(JSON.stringify({'phone': phone}));
    }
    function handleError(event) {
        messageDiv.style.display = 'block';
        messageDiv.innerHTML = "You may need to allow the certificate for our API, please visit <a href=\"" + API_DOMAIN + "\">" + API_DOMAIN + "</a>";
    }
    function handle(event) {
        let xmlHttp = event.target;
        if (xmlHttp.status == 200) {
            let result = JSON.parse(xmlHttp.responseText);
            window.location.replace("login.html?username=" + encodeURIComponent(result.username));
        } else {
            let result = JSON.parse(xmlHttp.responseText);
            if (result.hasOwnProperty('message')) {
                messageDiv.style.display = 'block';
                messageDiv.textContent = result.message;
            }
        }
    }
</script>
</body>

</html>